<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0C0C0E">
  <title>Protocole R√©√©ducation</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg: #0C0C0E; --bg-card: #18181B; --bg-card-hover: #1F1F23;
      --text: #FAFAFA; --text-2: #A1A1AA; --text-3: #71717A;
      --border: #27272A; --green: #22C55E; --orange: #F59E0B; --red: #EF4444;
      --radius: 16px; --radius-lg: 24px;
    }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; min-height: 100dvh; -webkit-font-smoothing: antialiased; }
    #app { max-width: 430px; margin: 0 auto; min-height: 100vh; min-height: 100dvh; position: relative; padding: 20px; padding-top: 60px; padding-bottom: 40px; }
    
    /* SELECTORS */
    .selectors { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px; }
    .selector { flex: 1; min-width: 80px; }
    .selector.full { flex: 100%; }
    .selector label { display: block; font-size: 12px; color: var(--text-2); margin-bottom: 8px; font-weight: 500; }
    .selector select { width: 100%; padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 15px; font-weight: 600; appearance: none; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='%23A1A1AA'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
    .selector select:focus { outline: none; border-color: var(--text-2); }
    .day-indicator { text-align: center; padding: 12px; background: linear-gradient(135deg, #6366F120, #8B5CF620); border-radius: var(--radius); margin-bottom: 16px; }
    .day-indicator strong { color: #8B5CF6; }
    
    /* HEADER */
    .header { text-align: center; margin-bottom: 28px; }
    .header h1 { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
    .header p { font-size: 14px; color: var(--text-2); }
    .phase-badge { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 30px; font-size: 14px; font-weight: 600; margin-top: 12px; }
    .phase-info { margin-top: 8px; font-size: 13px; color: var(--text-2); }
    
    /* EXERCISE LIST */
    .ex-list { display: flex; flex-direction: column; gap: 12px; }
    .ex-card { display: flex; align-items: center; padding: 16px; background: var(--bg-card); border-radius: var(--radius); cursor: pointer; position: relative; overflow: hidden; transition: transform 0.15s, background 0.15s; }
    .ex-card:active { transform: scale(0.98); background: var(--bg-card-hover); }
    .ex-card.done { opacity: 0.5; }
    .ex-card-accent { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .ex-card-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 26px; margin-right: 14px; flex-shrink: 0; }
    .ex-card-body { flex: 1; min-width: 0; }
    .ex-card-top { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
    .ex-card-top h3 { font-size: 16px; font-weight: 700; }
    .ex-card-cat { font-size: 11px; padding: 3px 8px; background: var(--bg); border-radius: 20px; color: var(--text-2); }
    .ex-card-desc { font-size: 13px; color: var(--text-2); margin-bottom: 8px; }
    .ex-card-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 12px; color: var(--text-3); }
    .ex-card-action { margin-left: 12px; flex-shrink: 0; }
    .ex-card-check { width: 32px; height: 32px; border-radius: 50%; background: var(--green); display: flex; align-items: center; justify-content: center; }
    .ex-card-check svg { width: 18px; height: 18px; }
    .ex-card-arrow { width: 20px; height: 20px; color: var(--text-3); }
    
    /* EMPTY STATE */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-2); }
    .empty-state span { font-size: 48px; display: block; margin-bottom: 16px; }
    
    /* EXERCISE SCREEN */
    .ex-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; overflow-y: auto; display: none; }
    .ex-screen.active { display: block; }
    .ex-header { display: flex; align-items: center; padding: 56px 20px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
    .ex-header h2 { flex: 1; text-align: center; font-size: 17px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .hdr-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--bg); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .hdr-btn svg { width: 22px; height: 22px; }
    .hdr-spacer { width: 40px; }
    
    /* INTRO */
    .intro-hero { height: 160px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
    .intro-hero span { font-size: 72px; position: relative; z-index: 1; }
    .intro-hero .glow { position: absolute; width: 200px; height: 200px; background: rgba(255,255,255,0.2); border-radius: 50%; filter: blur(60px); }
    .intro-body { padding: 20px; padding-bottom: 120px; display: flex; flex-direction: column; gap: 16px; }
    .info-block { background: var(--bg-card); padding: 16px; border-radius: var(--radius); }
    .info-block h4 { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; color: var(--text-2); margin-bottom: 12px; }
    .info-block h4 span { font-size: 18px; }
    .info-block p { font-size: 15px; line-height: 1.6; }
    .info-block.success { background: rgba(34,197,94,0.15); border-left: 4px solid var(--green); }
    .info-block.warning { background: rgba(245,158,11,0.15); border-left: 4px solid var(--orange); }
    .info-block.dosage { background: rgba(99,102,241,0.15); border-left: 4px solid #6366F1; }
    .steps-list { list-style: none; display: flex; flex-direction: column; gap: 12px; }
    .steps-list li { display: flex; gap: 12px; }
    .steps-list .num { width: 26px; height: 26px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; flex-shrink: 0; }
    .steps-list .txt { font-size: 15px; line-height: 1.5; }
    .steps-list .txt strong { display: block; }
    .steps-list .txt span { font-size: 13px; color: var(--text-2); }
    .warn-list { list-style: none; display: flex; flex-direction: column; gap: 6px; }
    .warn-list li { font-size: 15px; padding-left: 20px; position: relative; }
    .warn-list li::before { content: '‚úï'; position: absolute; left: 0; color: var(--orange); font-size: 12px; }
    .dosage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .dosage-item { text-align: center; padding: 12px; background: var(--bg); border-radius: 12px; }
    .dosage-item .val { font-size: 24px; font-weight: 800; color: #6366F1; }
    .dosage-item .lbl { font-size: 12px; color: var(--text-2); margin-top: 4px; }
    .progression-note { margin-top: 12px; padding: 10px; background: rgba(34,197,94,0.1); border-radius: 8px; font-size: 13px; color: var(--green); text-align: center; }
    .intro-footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(180deg, transparent, var(--bg) 30%); z-index: 20; display: flex; justify-content: center; }
    .intro-footer > div { max-width: 430px; width: 100%; }
    .btn { width: 100%; padding: 18px; border: none; border-radius: var(--radius); font-size: 17px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.15s; }
    .btn:active { transform: scale(0.98); }
    .btn svg { width: 20px; height: 20px; }
    .btn-primary { background: var(--text); color: var(--bg); }
    .btn-secondary { background: var(--bg-card); color: var(--text-2); }
    
    /* ACTIVE */
    .active-screen { display: none; flex-direction: column; align-items: center; padding: 40px 20px; padding-bottom: 120px; min-height: calc(100vh - 89px); position: relative; }
    .active-screen.show { display: flex; }
    .active-bg { position: absolute; top: 0; left: 0; right: 0; height: 50%; pointer-events: none; }
    
    /* TIMER */
    .timer { display: flex; flex-direction: column; align-items: center; gap: 32px; position: relative; z-index: 1; }
    .timer-ring { position: relative; width: 220px; height: 220px; }
    .timer-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .timer-ring .track { fill: none; stroke: var(--bg-card); stroke-width: 10; }
    .timer-ring .progress { fill: none; stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset 0.3s; }
    .timer-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .timer-time { font-size: 52px; font-weight: 800; letter-spacing: -2px; }
    .timer-label { font-size: 14px; color: var(--text-2); }
    .timer-btns { display: flex; gap: 16px; }
    .timer-btn { border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .timer-btn:active { transform: scale(0.95); }
    .timer-btn.main { width: 72px; height: 72px; }
    .timer-btn.main svg { width: 28px; height: 28px; }
    .timer-btn.sec { width: 52px; height: 52px; background: var(--bg-card); color: var(--text-2); }
    .timer-btn.sec svg { width: 22px; height: 22px; }
    
    /* REP COUNTER */
    .rep-counter { display: flex; flex-direction: column; align-items: center; gap: 20px; position: relative; z-index: 1; }
    .side-switch { display: flex; gap: 8px; background: var(--bg-card); padding: 4px; border-radius: var(--radius); }
    .side-btn { padding: 10px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; color: var(--text-3); border: none; background: none; cursor: pointer; }
    .side-btn.active { background: var(--text); color: var(--bg); }
    .set-info { font-size: 14px; color: var(--text-2); }
    .rep-circle { width: 200px; height: 200px; position: relative; cursor: pointer; }
    .rep-circle:active { transform: scale(0.98); }
    .rep-circle svg { position: absolute; inset: 0; transform: rotate(-90deg); }
    .rep-circle .track { fill: none; stroke: var(--bg-card); stroke-width: 10; }
    .rep-circle .progress { fill: none; stroke-width: 10; stroke-linecap: round; transition: stroke-dasharray 0.3s; }
    .rep-inner { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .rep-num { font-size: 64px; font-weight: 800; }
    .rep-num .sep { font-size: 28px; color: var(--text-3); margin: 0 4px; }
    .rep-num .tot { font-size: 28px; color: var(--text-2); font-weight: 600; }
    .rep-hint { font-size: 13px; color: var(--text-3); }
    .hold-num { font-size: 72px; font-weight: 800; color: var(--orange); }
    .hold-txt { font-size: 16px; color: var(--orange); font-weight: 600; }
    .rep-circle.holding { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .hold-ring { position: absolute; inset: 0; border-radius: 50%; border: 3px solid var(--orange); animation: ringPulse 1s infinite; pointer-events: none; }
    @keyframes ringPulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.15); opacity: 0; } }
    .hold-info { font-size: 14px; color: var(--text-2); margin-top: 8px; }
    
    .tip-box { margin-top: 32px; padding: 16px 20px; background: var(--bg-card); border-radius: var(--radius); display: flex; align-items: center; gap: 12px; max-width: 320px; }
    .tip-box span { font-size: 20px; }
    .tip-box p { font-size: 14px; color: var(--text-2); line-height: 1.4; }
    
    /* FEEDBACK */
    .feedback-screen { display: none; flex-direction: column; padding: 40px 20px; padding-bottom: 120px; min-height: calc(100vh - 89px); }
    .feedback-screen.show { display: flex; }
    .fb-top { text-align: center; margin-bottom: 40px; }
    .fb-top span { font-size: 72px; display: block; margin-bottom: 16px; animation: bounce 0.6s; }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 30% { transform: scale(1.3); } 60% { transform: scale(0.9); } }
    .fb-top h2 { font-size: 32px; font-weight: 800; margin-bottom: 8px; }
    .fb-top p { color: var(--text-2); }
    .fb-title { font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 8px; }
    .fb-sub { text-align: center; color: var(--text-2); font-size: 14px; margin-bottom: 24px; }
    .fb-options { display: flex; flex-direction: column; gap: 12px; flex: 1; }
    .fb-opt { display: flex; align-items: center; padding: 16px; background: var(--bg-card); border: 2px solid transparent; border-radius: var(--radius); cursor: pointer; transition: all 0.2s; }
    .fb-opt:active { transform: scale(0.98); }
    .fb-opt.selected { border-color: var(--green); }
    .fb-opt.selected.orange { border-color: var(--orange); }
    .fb-opt.selected.red { border-color: var(--red); }
    .fb-opt .icon { font-size: 28px; margin-right: 16px; }
    .fb-opt .txt { flex: 1; }
    .fb-opt .txt strong { font-size: 16px; display: block; }
    .fb-opt .txt span { font-size: 13px; color: var(--text-2); }
    .fb-opt .check { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; }
    .fb-opt.selected .check { opacity: 1; }
    .fb-opt .check svg { width: 16px; height: 16px; fill: white; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="exercise-screen" class="ex-screen"></div>

  <script>
    // ============================================
    // DONN√âES - 3 PHASES AVEC PROGRESSION AUTOMATIQUE
    // ============================================
    
    const EXERCISES = {
      E0: {
        id: 'E0', name: 'Reset anti-bracing', shortName: 'Reset', icon: 'üå¨Ô∏è',
        category: 'Respiration',
        description: 'Respiration diaphragmatique + micro-bascule du bassin',
        position: 'Sur le dos, genoux pli√©s, pieds au sol. Alternative : sur le c√¥t√© avec coussin.',
        steps: [
          { text: 'Inspire par le nez 3-4 secondes', detail: 'Laisse les c√¥tes s\'ouvrir' },
          { text: 'Expire par la bouche 6-8 secondes', detail: 'Comme souffler sur une vitre' },
          { text: 'Micro-bascule du bassin en fin d\'expiration', detail: 'Aplatis l√©g√®rement le bas du dos' },
          { text: 'Reviens en position neutre', detail: 'Amplitude minuscule' }
        ],
        feel: 'Rel√¢chement progressif de la zone lombaire',
        warnings: ['Ne rentre pas le ventre', 'Ne bloque pas ta respiration', 'Garde une amplitude minime'],
        gradient: ['#6366F1', '#8B5CF6'],
        dosageByPhase: {
          1: { baseReps: 6, sets: 2, holdTime: null, durationMin: null, perSide: false, freq: '1√ó/jour', progressionRule: null }
        }
      },
      
      E1: {
        id: 'E1', name: 'Abduction assise', shortName: 'Abduction', icon: 'ü™ë',
        category: 'Activation',
        description: 'Activation du gluteus medius en position stable',
        position: 'Assis sur chaise, pieds au sol (largeur bassin), √©lastique au-dessus des genoux, dos soutenu.',
        steps: [
          { text: 'Grandis-toi sur la chaise', detail: 'Cage thoracique au-dessus du bassin' },
          { text: 'Pousse les genoux vers l\'ext√©rieur', detail: 'Contre l\'√©lastique, effort 20-40%' },
          { text: 'Maintiens la tenue', detail: 'Sans te pencher, sans serrer le ventre' },
          { text: 'Rel√¢che compl√®tement', detail: 'Repos 5 secondes' }
        ],
        feel: 'Activation sur le c√¥t√© de la fesse (partie arri√®re-lat√©rale)',
        warnings: ['Ne te penche pas', '√âvite le serrage abdominal', 'N\'utilise pas trop de force'],
        gradient: ['#10B981', '#34D399'],
        dosageByPhase: {
          // Phase 1 : 2√ó6 reps base, tenue 8s, +1 rep tous les 4j
          1: { baseReps: 6, sets: 2, holdTime: 8, durationMin: null, perSide: false, freq: '5-6√ó/sem', progressionRule: { type: 'reps', perDays: 4 } },
          // Phase 2 : 2√ó10 reps base, tenue 10s
          2: { baseReps: 10, sets: 2, holdTime: 10, durationMin: null, perSide: false, freq: '3-4√ó/sem', progressionRule: null },
          // Phase 3 : maintenance
          3: { baseReps: 10, sets: 2, holdTime: 10, durationMin: null, perSide: false, freq: '2√ó/sem', progressionRule: null }
        }
      },
      
      E3: {
        id: 'E3', name: 'Appui unipodal', shortName: 'Unipodal', icon: 'ü¶©',
        category: 'Stabilit√©',
        description: 'Stabilit√© lat√©rale sans solliciter le dos',
        position: 'Debout pr√®s d\'un mur, 1-2 doigts en appui l√©ger. Pied en tr√©pied.',
        steps: [
          { text: 'D√©colle l\'autre pied de 2-3 cm', detail: 'Pas besoin de lever haut' },
          { text: 'Aligne ton genou d\'appui', detail: 'Au-dessus du 2e-3e orteil' },
          { text: 'Garde le bassin √† niveau', detail: 'La hanche du c√¥t√© lev√© ne tombe pas' },
          { text: 'Respire normalement', detail: 'Tiens X secondes' }
        ],
        feel: 'Le fessier de la jambe d\'appui qui stabilise',
        warnings: ['Ne te penche pas sur la jambe d\'appui', 'Ne griffe pas le sol'],
        gradient: ['#EC4899', '#F472B6'],
        dosageByPhase: {
          // Phase 1 : 2√ó15s base/c√¥t√©, +5s par semaine
          1: { baseReps: 1, sets: 2, holdTime: 15, durationMin: null, perSide: true, freq: '5-6√ó/sem', progressionRule: { type: 'holdTime', perDays: 7, increment: 5 } }
        }
      },
      
      E4: {
        id: 'E4', name: 'Sit-to-Stand', shortName: 'Sit-Stand', icon: 'üèãÔ∏è',
        category: 'Renforcement',
        description: 'Quadriceps + fessiers en pattern fonctionnel',
        position: 'Assis sur chaise haute, pieds sous les genoux, largeur bassin.',
        steps: [
          { text: 'Adopte un "dos long"', detail: 'Ne cambre pas le dos' },
          { text: 'Penche l√©g√®rement le buste', detail: 'Charni√®re au niveau des hanches' },
          { text: 'L√®ve-toi en poussant le sol', detail: 'Utilise tes jambes, pas ton dos' },
          { text: 'Redescends en 3 secondes', detail: 'Contr√¥le, touche, remonte' }
        ],
        feel: 'Cuisses et fessiers qui travaillent ensemble',
        warnings: ['Pas de coup de rein', 'Genou align√© (pas vers l\'int√©rieur)', 'Ne descends pas trop bas'],
        gradient: ['#EF4444', '#F87171'],
        dosageByPhase: {
          // Phase 1 : 2√ó4 reps base, +1 rep tous les 4j
          1: { baseReps: 4, sets: 2, holdTime: null, durationMin: null, perSide: false, freq: '3√ó/sem', progressionRule: { type: 'reps', perDays: 4 } },
          // Phase 2 : 3√ó8 reps base, +1 rep tous les 4j
          2: { baseReps: 8, sets: 3, holdTime: null, durationMin: null, perSide: false, freq: '3√ó/sem', progressionRule: { type: 'reps', perDays: 4 } },
          // Phase 3 : maintenance
          3: { baseReps: 10, sets: 3, holdTime: null, durationMin: null, perSide: false, freq: '2√ó/sem', progressionRule: null }
        }
      },
      
      E5: {
        id: 'E5', name: 'V√©lo d\'appartement', shortName: 'V√©lo', icon: 'üö¥',
        category: 'Cardio',
        description: 'Reconditionnement cardiovasculaire doux',
        position: 'Selle haute (genou l√©g√®rement fl√©chi en bas), soutien lombaire, r√©sistance minimale.',
        steps: [
          { text: 'R√®gle ta selle correctement', detail: 'Genou l√©g√®rement fl√©chi en bas de p√©dale' },
          { text: 'P√©dale √† rythme confortable', detail: 'Tu dois pouvoir parler facilement (RPE 2-3)' },
          { text: 'Fais des pauses si besoin', detail: 'L√®ve-toi quelques secondes si inconfort' }
        ],
        feel: 'Effort l√©ger, jambes qui chauffent doucement',
        warnings: ['√âvite l\'intensit√© trop forte', 'Ne te penche pas en avant'],
        gradient: ['#0EA5E9', '#38BDF8'],
        dosageByPhase: {
          // Phase 1 : 10 min base, +2 min par semaine
          1: { baseReps: null, sets: 1, holdTime: null, durationMin: 10, perSide: false, freq: '4-6√ó/sem', progressionRule: { type: 'duration', perDays: 7, increment: 2 } },
          // Phase 2 : 25 min base, +2 min par semaine
          2: { baseReps: null, sets: 1, holdTime: null, durationMin: 25, perSide: false, freq: '4-5√ó/sem', progressionRule: { type: 'duration', perDays: 7, increment: 2 } },
          // Phase 3 : 30 min
          3: { baseReps: null, sets: 1, holdTime: null, durationMin: 30, perSide: false, freq: '3-4√ó/sem', progressionRule: null }
        }
      },
      
      E6: {
        id: 'E6', name: 'Step-down contr√¥l√©', shortName: 'Step-down', icon: 'ü™ú',
        category: 'Renforcement',
        description: 'Contr√¥le hanche/genou anti-valgus (pr√©pa course)',
        position: 'Debout sur une marche basse (10-15 cm).',
        steps: [
          { text: 'Monte sur la marche', detail: 'Avec la jambe √† travailler' },
          { text: 'Descends l\'autre talon vers le sol', detail: 'En 3 secondes, contr√¥le total' },
          { text: 'Garde le genou d\'appui align√©', detail: 'Au-dessus du 2e-3e orteil' },
          { text: 'Remonte sans √†-coups', detail: 'Pousse avec la jambe d\'appui' }
        ],
        feel: 'La cuisse de la jambe d\'appui qui contr√¥le le mouvement',
        warnings: ['Le genou ne doit pas s\'effondrer vers l\'int√©rieur', 'Le bassin reste stable'],
        gradient: ['#F97316', '#FB923C'],
        dosageByPhase: {
          // Phase 2 : 2√ó5/c√¥t√© base, +1 rep par semaine
          2: { baseReps: 5, sets: 2, holdTime: null, durationMin: null, perSide: true, freq: '2-3√ó/sem', progressionRule: { type: 'reps', perDays: 7 } },
          // Phase 3 : 2√ó10/c√¥t√© maintenance
          3: { baseReps: 10, sets: 2, holdTime: null, durationMin: null, perSide: true, freq: '2√ó/sem', progressionRule: null }
        }
      },
      
      E7: {
        id: 'E7', name: 'Mini-pont fessier', shortName: 'Mini-pont', icon: 'üåâ',
        category: 'Optionnel',
        description: 'Activation du grand fessier (prudence, optionnel)',
        position: 'Allong√© sur le dos, genoux pli√©s, pieds proches des fesses.',
        steps: [
          { text: 'Pr√©-contracte l√©g√®rement les fesses', detail: 'Avant tout mouvement' },
          { text: 'Monte le bassin de 2-5 cm MAX', detail: 'Pas plus haut !' },
          { text: 'Maintiens 2 secondes', detail: 'En gardant la contraction' },
          { text: 'Redescends tr√®s lentement', detail: 'Contr√¥le total' }
        ],
        feel: 'Les fessiers qui se contractent, PAS le bas du dos',
        warnings: ['Ne monte pas trop haut', 'Ne cambre pas le dos', 'STOP si douleur lombaire ‚Üí retirer l\'exercice'],
        gradient: ['#14B8A6', '#2DD4BF'],
        dosageByPhase: {
          // Phase 2 : 1√ó5 reps base, +1 rep par semaine
          2: { baseReps: 5, sets: 1, holdTime: 2, durationMin: null, perSide: false, freq: '2-3√ó/sem (optionnel)', progressionRule: { type: 'reps', perDays: 7 } }
        }
      },
      
      E8: {
        id: 'E8', name: 'Marche', shortName: 'Marche', icon: 'üö∂',
        category: 'Cardio',
        description: 'Marche √† rythme confortable, terrain plat',
        position: 'Ext√©rieur ou tapis de marche, chaussures confortables.',
        steps: [
          { text: 'Adopte une posture droite', detail: 'Regard devant, √©paules rel√¢ch√©es' },
          { text: 'Marche √† allure confortable', detail: 'Tu dois pouvoir parler (RPE 2-3)' },
          { text: '√âvite les pentes au d√©but', detail: 'Terrain plat de pr√©f√©rence' },
          { text: 'Fais des pauses si besoin', detail: 'Assieds-toi quelques minutes si tension' }
        ],
        feel: 'Effort l√©ger, sensation de mouvement global',
        warnings: ['√âvite les descentes longues', 'Ne force pas l\'allure'],
        gradient: ['#84CC16', '#A3E635'],
        dosageByPhase: {
          1: { baseReps: null, sets: 1, holdTime: null, durationMin: 30, perSide: false, freq: 'Tous les jours', progressionRule: null },
          2: { baseReps: null, sets: 1, holdTime: null, durationMin: 30, perSide: false, freq: 'Tous les jours', progressionRule: null },
          3: { baseReps: null, sets: 1, holdTime: null, durationMin: 30, perSide: false, freq: 'Tous les jours', progressionRule: null }
        }
      },
      
      E9: {
        id: 'E9', name: '√âl√©vation scapulaire', shortName: 'Alt√®res', icon: 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
        category: 'Renforcement',
        description: 'Renforcement √©paules/haut du dos, alt√®res 2kg',
        position: 'Debout, pieds largeur bassin, alt√®res 2kg en main, bras le long du corps.',
        steps: [
          { text: 'Tiens les alt√®res bras tendus', detail: 'Coudes l√©g√®rement d√©verrouill√©s' },
          { text: 'L√®ve les bras devant toi', detail: 'Dans le plan de la scapula (angle 130-140¬∞ avec le torse)' },
          { text: 'Monte jusqu\'√† hauteur d\'√©paules', detail: 'Pas plus haut' },
          { text: 'Redescends lentement', detail: 'Contr√¥le sur 2-3 secondes' }
        ],
        feel: 'Travail des √©paules et stabilisateurs du haut du dos',
        warnings: ['Ne cambre pas le dos', 'Ne monte pas trop haut', 'Garde les √©paules basses'],
        gradient: ['#8B5CF6', '#A78BFA'],
        dosageByPhase: {
          // Toutes phases : 2√ó5 reps base, +1 rep tous les 4j
          1: { baseReps: 5, sets: 2, holdTime: null, durationMin: null, perSide: false, freq: 'Tous les jours', progressionRule: { type: 'reps', perDays: 4 } },
          2: { baseReps: 5, sets: 2, holdTime: null, durationMin: null, perSide: false, freq: 'Tous les jours', progressionRule: { type: 'reps', perDays: 4 } },
          3: { baseReps: 5, sets: 2, holdTime: null, durationMin: null, perSide: false, freq: 'Tous les jours', progressionRule: { type: 'reps', perDays: 4 } }
        }
      }
    };

    // 3 PHASES
    const PHASES = {
      1: { 
        name: 'Phase 1', 
        title: 'Activation prudente', 
        duration: '4-6 semaines', 
        icon: 'üåø', 
        gradient: ['#6366F1', '#8B5CF6'], 
        objective: 'Hanche stable, quads, moins de bracing'
      },
      2: { 
        name: 'Phase 2', 
        title: 'Renforcement fonctionnel', 
        duration: '4-6 semaines', 
        icon: 'üå≥', 
        gradient: ['#F59E0B', '#FBBF24'], 
        objective: 'Contr√¥le dynamique, pr√©paration course'
      },
      3: { 
        name: 'Phase 3', 
        title: 'Retour course', 
        duration: '6-12+ semaines', 
        icon: 'üèÉ', 
        gradient: ['#EC4899', '#F472B6'], 
        objective: 'Tol√©rer l\'impact sans r√©veiller lombaires/genou'
      }
    };

    // PLANNING HEBDOMADAIRE PAR PHASE
    const SCHEDULE = {
      // Phase 1 : E0 + E1 + E3 + E4 + E5 + E8 + E9
      1: { 
        0: ['E0', 'E1', 'E8', 'E9'],  // Dimanche
        1: ['E0', 'E1', 'E3', 'E4', 'E5', 'E8', 'E9'],  // Lundi
        2: ['E0', 'E1', 'E3', 'E5', 'E8', 'E9'],  // Mardi
        3: ['E0', 'E1', 'E3', 'E4', 'E5', 'E8', 'E9'],  // Mercredi
        4: ['E0', 'E1', 'E3', 'E5', 'E8', 'E9'],  // Jeudi
        5: ['E0', 'E1', 'E3', 'E4', 'E5', 'E8', 'E9'],  // Vendredi
        6: ['E0', 'E1', 'E5', 'E8', 'E9']  // Samedi
      },
      // Phase 2 : E1 + E4 + E5 + E6 + E7 + E8 + E9
      2: { 
        0: ['E1', 'E8', 'E9'],  // Dimanche - repos actif
        1: ['E1', 'E4', 'E6', 'E5', 'E8', 'E9'],  // Lundi
        2: ['E5', 'E8', 'E9'],  // Mardi
        3: ['E1', 'E4', 'E7', 'E5', 'E8', 'E9'],  // Mercredi
        4: ['E5', 'E8', 'E9'],  // Jeudi
        5: ['E1', 'E4', 'E6', 'E5', 'E8', 'E9'],  // Vendredi
        6: ['E5', 'E8', 'E9']  // Samedi
      },
      // Phase 3 : maintenance + E8 + E9
      3: { 
        0: ['E1', 'E8', 'E9'],  // Dimanche
        1: ['E1', 'E4', 'E6', 'E8', 'E9'],  // Lundi
        2: ['E5', 'E8', 'E9'],  // Mardi
        3: ['E1', 'E4', 'E8', 'E9'],  // Mercredi
        4: ['E5', 'E8', 'E9'],  // Jeudi
        5: ['E1', 'E4', 'E6', 'E8', 'E9'],  // Vendredi
        6: ['E5', 'E8', 'E9']  // Samedi
      }
    };

    const DAYS = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

    // ============================================
    // STATE
    // ============================================
    let phase = 1;
    let weekInPhase = 1;  // Semaine 1 √† 6 dans la phase
    let dayOfWeek = new Date().getDay();
    let completed = {};
    let currentEx = null;
    let exStep = 'intro';
    let feedback = null;
    let timerVal = 0;
    let timerRunning = false;
    let timerInterval = null;
    let repCount = 0;
    let setCount = 1;
    let side = 'left';
    let holding = false;
    let holdTime = 0;
    let holdInterval = null;

    // ============================================
    // CALCUL DU JOUR DANS LA PHASE
    // ============================================
    function getDayInPhase() {
      // Dimanche = 0, donc on ajuste pour que Lundi = jour 1
      const dayIndex = dayOfWeek === 0 ? 7 : dayOfWeek;
      return (weekInPhase - 1) * 7 + dayIndex;
    }

    // ============================================
    // CALCUL DU DOSAGE AVEC PROGRESSION
    // ============================================
    function getDosage(exId) {
      const ex = EXERCISES[exId];
      let baseDosage = ex.dosageByPhase[phase];
      
      // Si pas de dosage pour cette phase, chercher la phase inf√©rieure
      if (!baseDosage) {
        for (let p = phase - 1; p >= 1; p--) {
          if (ex.dosageByPhase[p]) {
            baseDosage = ex.dosageByPhase[p];
            break;
          }
        }
      }
      
      if (!baseDosage) {
        return { reps: 5, sets: 1, holdTime: null, durationMin: null, perSide: false, freq: '', progressionText: '' };
      }

      const dayInPhase = getDayInPhase();
      let reps = baseDosage.baseReps;
      let holdTimeSec = baseDosage.holdTime;
      let durationMin = baseDosage.durationMin;
      let progressionText = '';

      // Appliquer la progression si r√®gle d√©finie
      if (baseDosage.progressionRule) {
        const rule = baseDosage.progressionRule;
        const increment = rule.increment || 1;
        const progressionSteps = Math.floor((dayInPhase - 1) / rule.perDays);

        if (rule.type === 'reps' && reps !== null) {
          const addedReps = progressionSteps * increment;
          reps = baseDosage.baseReps + addedReps;
          if (addedReps > 0) {
            progressionText = `+${addedReps} rep${addedReps > 1 ? 's' : ''} (progression J${dayInPhase})`;
          }
        } else if (rule.type === 'holdTime' && holdTimeSec !== null) {
          const addedSeconds = progressionSteps * increment;
          holdTimeSec = baseDosage.holdTime + addedSeconds;
          if (addedSeconds > 0) {
            progressionText = `+${addedSeconds}s (progression J${dayInPhase})`;
          }
        } else if (rule.type === 'duration' && durationMin !== null) {
          const addedMinutes = progressionSteps * increment;
          durationMin = baseDosage.durationMin + addedMinutes;
          if (addedMinutes > 0) {
            progressionText = `+${addedMinutes} min (progression J${dayInPhase})`;
          }
        }
      }

      return {
        reps: reps,
        sets: baseDosage.sets,
        holdTime: holdTimeSec,
        durationMin: durationMin,
        perSide: baseDosage.perSide,
        freq: baseDosage.freq,
        progressionText: progressionText,
        progressionRule: baseDosage.progressionRule
      };
    }

    // ============================================
    // RENDER
    // ============================================
    function render() {
      const exercises = SCHEDULE[phase]?.[dayOfWeek] || [];
      const p = PHASES[phase];
      const completedCount = Object.keys(completed).filter(id => exercises.includes(id)).length;
      const dayInPhase = getDayInPhase();
      
      document.getElementById('app').innerHTML = `
        <div class="selectors">
          <div class="selector">
            <label>Phase</label>
            <select id="phase-select" onchange="setPhase(this.value)">
              ${[1,2,3].map(n => `<option value="${n}" ${n===phase?'selected':''}>${PHASES[n].icon} Phase ${n}</option>`).join('')}
            </select>
          </div>
          <div class="selector">
            <label>Semaine</label>
            <select id="week-select" onchange="setWeek(this.value)">
              ${[1,2,3,4,5,6].map(n => `<option value="${n}" ${n===weekInPhase?'selected':''}>Sem. ${n}</option>`).join('')}
            </select>
          </div>
          <div class="selector">
            <label>Jour</label>
            <select id="day-select" onchange="setDay(this.value)">
              ${DAYS.map((d,i) => `<option value="${i}" ${i===dayOfWeek?'selected':''}>${d.slice(0,3)}</option>`).join('')}
            </select>
          </div>
        </div>
        
        <div class="day-indicator">
          üìÖ <strong>Jour ${dayInPhase}</strong> de la phase (sur ~42 jours)
        </div>
        
        <div class="header">
          <h1>Programme du jour</h1>
          <p>${completedCount}/${exercises.length} exercices</p>
          <div class="phase-badge" style="background: linear-gradient(135deg, ${p.gradient[0]}, ${p.gradient[1]})">
            ${p.icon} ${p.name} ‚Äî ${p.title}
          </div>
          <div class="phase-info">‚è± <strong>${p.duration}</strong> ‚Äî ${p.objective}</div>
        </div>
        
        ${exercises.length === 0 ? `
          <div class="empty-state">
            <span>üò¥</span>
            <p>Jour de repos.</p>
          </div>
        ` : `
          <div class="ex-list">
            ${exercises.map(id => renderCard(id)).join('')}
          </div>
        `}
      `;
    }

    function renderCard(id) {
      const ex = EXERCISES[id];
      const dosage = getDosage(id);
      const done = !!completed[id];
      
      return `
        <div class="ex-card ${done ? 'done' : ''}" onclick="openExercise('${id}')">
          <div class="ex-card-accent" style="background: linear-gradient(180deg, ${ex.gradient[0]}, ${ex.gradient[1]})"></div>
          <div class="ex-card-icon" style="background: linear-gradient(135deg, ${ex.gradient[0]}40, ${ex.gradient[1]}40)">${ex.icon}</div>
          <div class="ex-card-body">
            <div class="ex-card-top">
              <h3>${ex.shortName}</h3>
              <span class="ex-card-cat">${ex.category}</span>
            </div>
            <p class="ex-card-desc">${ex.description}</p>
            <div class="ex-card-meta">
              ${dosage.durationMin ? `<span>‚è± ${dosage.durationMin} min</span>` : ''}
              ${dosage.reps && dosage.sets ? `<span>üîÑ ${dosage.sets}√ó${dosage.reps}</span>` : ''}
              ${dosage.perSide ? `<span>‚ÜîÔ∏è /c√¥t√©</span>` : ''}
              ${dosage.holdTime ? `<span>‚è∏ ${dosage.holdTime}s</span>` : ''}
              ${dosage.progressionText ? `<span style="color: var(--green)">üìà</span>` : ''}
            </div>
          </div>
          <div class="ex-card-action">
            ${done ? `<div class="ex-card-check"><svg viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>` : `<svg class="ex-card-arrow" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>`}
          </div>
        </div>
      `;
    }

    function renderExerciseScreen() {
      const ex = EXERCISES[currentEx];
      const dosage = getDosage(currentEx);
      const screen = document.getElementById('exercise-screen');
      
      // Texte de progression
      let progressionRuleText = '';
      if (dosage.progressionRule) {
        const rule = dosage.progressionRule;
        if (rule.type === 'reps') {
          progressionRuleText = `+1 rep tous les ${rule.perDays} jours`;
        } else if (rule.type === 'holdTime') {
          progressionRuleText = `+${rule.increment}s tous les ${rule.perDays} jours`;
        } else if (rule.type === 'duration') {
          progressionRuleText = `+${rule.increment} min tous les ${rule.perDays} jours`;
        }
      }
      
      screen.innerHTML = `
        <div class="ex-header">
          <button class="hdr-btn" onclick="closeExercise()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
          <h2><span>${ex.icon}</span> ${ex.name}</h2>
          <div class="hdr-spacer"></div>
        </div>
        
        <!-- INTRO -->
        <div class="intro-body" style="display: ${exStep === 'intro' ? 'flex' : 'none'}">
          <div class="intro-hero" style="background: linear-gradient(135deg, ${ex.gradient[0]}, ${ex.gradient[1]})">
            <span>${ex.icon}</span>
            <div class="glow"></div>
          </div>
          
          <div class="info-block dosage">
            <h4><span>üìä</span> Dosage Jour ${getDayInPhase()}</h4>
            <div class="dosage-grid">
              ${dosage.durationMin ? `<div class="dosage-item"><div class="val">${dosage.durationMin}</div><div class="lbl">minutes</div></div>` : ''}
              ${dosage.sets ? `<div class="dosage-item"><div class="val">${dosage.sets}</div><div class="lbl">s√©ries</div></div>` : ''}
              ${dosage.reps ? `<div class="dosage-item"><div class="val">${dosage.reps}</div><div class="lbl">reps</div></div>` : ''}
              ${dosage.holdTime ? `<div class="dosage-item"><div class="val">${dosage.holdTime}s</div><div class="lbl">tenue</div></div>` : ''}
            </div>
            ${dosage.perSide ? '<p style="margin-top: 8px; text-align: center; font-size: 13px;">‚ÜîÔ∏è Chaque c√¥t√©</p>' : ''}
            ${dosage.progressionText ? `<div class="progression-note">üìà ${dosage.progressionText}</div>` : ''}
            ${progressionRuleText ? `<p style="margin-top: 8px; font-size: 12px; color: var(--text-3); text-align: center;">R√®gle : ${progressionRuleText}</p>` : ''}
          </div>
          
          <div class="info-block">
            <h4><span>üìç</span> Position de d√©part</h4>
            <p>${ex.position}</p>
          </div>
          
          <div class="info-block">
            <h4><span>‚ñ∂Ô∏è</span> Ex√©cution</h4>
            <ol class="steps-list">
              ${ex.steps.map((s,i) => `<li><div class="num">${i+1}</div><div class="txt"><strong>${s.text}</strong><span>${s.detail}</span></div></li>`).join('')}
            </ol>
          </div>
          
          <div class="info-block success">
            <h4><span>‚úÖ</span> Tu dois sentir</h4>
            <p>${ex.feel}</p>
          </div>
          
          <div class="info-block warning">
            <h4><span>‚ö†Ô∏è</span> √âvite</h4>
            <ul class="warn-list">${ex.warnings.map(w => `<li>${w}</li>`).join('')}</ul>
          </div>
        </div>
        
        <!-- ACTIVE -->
        <div class="active-screen ${exStep === 'active' ? 'show' : ''}">
          <div class="active-bg" style="background: linear-gradient(180deg, ${ex.gradient[0]}20, transparent)"></div>
          ${dosage.durationMin ? renderTimer(ex, dosage) : renderRepCounter(ex, dosage)}
          <div class="tip-box"><span>üí°</span><p>${ex.feel}</p></div>
        </div>
        
        <!-- FEEDBACK -->
        <div class="feedback-screen ${exStep === 'feedback' ? 'show' : ''}">
          <div class="fb-top">
            <span>üéâ</span>
            <h2>Bravo !</h2>
            <p>Exercice termin√©</p>
          </div>
          <h3 class="fb-title">Comment te sens-tu ?</h3>
          <p class="fb-sub">√âvalue ta r√©ponse √† cet exercice</p>
          <div class="fb-options">
            <div class="fb-opt ${feedback === 'green' ? 'selected' : ''}" onclick="selectFeedback('green')">
              <span class="icon">üü¢</span>
              <div class="txt"><strong>Vert</strong><span>Douleur ‚â§ 2/10 ‚Üí ON PROGRESSE</span></div>
              <div class="check" style="background: var(--green)"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
            </div>
            <div class="fb-opt ${feedback === 'orange' ? 'selected orange' : ''}" onclick="selectFeedback('orange')">
              <span class="icon">üü†</span>
              <div class="txt"><strong>Orange</strong><span>Douleur 3-4/10 ‚Üí Garder mais -30-50%</span></div>
              <div class="check" style="background: var(--orange)"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
            </div>
            <div class="fb-opt ${feedback === 'red' ? 'selected red' : ''}" onclick="selectFeedback('red')">
              <span class="icon">üî¥</span>
              <div class="txt"><strong>Rouge</strong><span>Douleur ‚â• 5/10 ‚Üí STOP, phase pr√©c√©dente</span></div>
              <div class="check" style="background: var(--red)"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
            </div>
          </div>
        </div>
        
        <!-- FOOTER -->
        <div class="intro-footer">
          <div>
            ${exStep === 'intro' ? `
              <button class="btn btn-primary" onclick="startActive()" style="background: linear-gradient(135deg, ${ex.gradient[0]}, ${ex.gradient[1]})">
                Commencer <svg viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
              </button>
            ` : exStep === 'active' ? `
              <button class="btn btn-secondary" onclick="finishExercise()">Terminer l'exercice</button>
            ` : `
              <button class="btn btn-primary" onclick="completeExercise()" ${!feedback ? 'disabled style="opacity:0.4"' : ''}>Continuer</button>
            `}
          </div>
        </div>
      `;
      
      screen.classList.add('active');
    }

    function renderTimer(ex, dosage) {
      const total = dosage.durationMin * 60;
      const elapsed = total - timerVal;
      const pct = (elapsed / total) * 100;
      const circ = 2 * Math.PI * 46;
      const offset = circ - (pct / 100) * circ;
      const mins = Math.floor(timerVal / 60);
      const secs = timerVal % 60;
      
      return `
        <div class="timer">
          <div class="timer-ring">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="46" class="track"/>
              <circle cx="50" cy="50" r="46" class="progress" stroke="${ex.gradient[1]}" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/>
            </svg>
            <div class="timer-center">
              <div class="timer-time">${mins}:${secs.toString().padStart(2,'0')}</div>
              <div class="timer-label">${timerRunning ? 'En cours' : 'Pause'}</div>
            </div>
          </div>
          <div class="timer-btns">
            <button class="timer-btn sec" onclick="resetTimer()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
            <button class="timer-btn main" onclick="toggleTimer()" style="background: linear-gradient(135deg, ${ex.gradient[0]}, ${ex.gradient[1]})">
              ${timerRunning ? '<svg viewBox="0 0 24 24" fill="white"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>' : '<svg viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>'}
            </button>
            <button class="timer-btn sec" onclick="finishExercise()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></button>
          </div>
        </div>
      `;
    }

    function renderRepCounter(ex, dosage) {
      const total = dosage.reps || 1;
      const pct = (repCount / total) * 100;
      
      return `
        <div class="rep-counter">
          ${dosage.perSide ? `
            <div class="side-switch">
              <button class="side-btn ${side === 'left' ? 'active' : ''}">‚Üê Gauche</button>
              <button class="side-btn ${side === 'right' ? 'active' : ''}">Droit ‚Üí</button>
            </div>
          ` : ''}
          <div class="set-info">S√©rie ${setCount} sur ${dosage.sets}</div>
          <div class="rep-circle ${holding ? 'holding' : ''}" onclick="tapRep()">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="46" class="track"/>
              <circle cx="50" cy="50" r="46" class="progress" stroke="${ex.gradient[1]}" stroke-dasharray="${pct * 2.89} 289"/>
            </svg>
            <div class="rep-inner">
              ${holding ? `
                <div class="hold-num">${holdTime}</div>
                <div class="hold-txt">Maintiens</div>
              ` : `
                <div class="rep-num">${repCount}<span class="sep">/</span><span class="tot">${total}</span></div>
                <div class="rep-hint">Tap pour compter</div>
              `}
            </div>
            ${holding ? '<div class="hold-ring"></div>' : ''}
          </div>
          ${dosage.holdTime && !holding ? `<div class="hold-info">üí° Maintiens ${dosage.holdTime}s par rep</div>` : ''}
        </div>
      `;
    }

    // ============================================
    // ACTIONS
    // ============================================
    function setPhase(val) {
      phase = parseInt(val);
      weekInPhase = 1;  // Reset √† semaine 1
      completed = {};
      render();
    }

    function setWeek(val) {
      weekInPhase = parseInt(val);
      completed = {};
      render();
    }

    function setDay(val) {
      dayOfWeek = parseInt(val);
      completed = {};
      render();
    }

    function openExercise(id) {
      const dosage = getDosage(id);
      currentEx = id;
      exStep = 'intro';
      feedback = null;
      timerVal = dosage.durationMin ? dosage.durationMin * 60 : 0;
      timerRunning = false;
      repCount = 0;
      setCount = 1;
      side = 'left';
      holding = false;
      holdTime = dosage.holdTime || 0;
      renderExerciseScreen();
    }

    function closeExercise() {
      clearInterval(timerInterval);
      clearInterval(holdInterval);
      document.getElementById('exercise-screen').classList.remove('active');
      currentEx = null;
    }

    function startActive() {
      const dosage = getDosage(currentEx);
      timerVal = dosage.durationMin ? dosage.durationMin * 60 : 0;
      exStep = 'active';
      renderExerciseScreen();
    }

    function toggleTimer() {
      timerRunning = !timerRunning;
      if (timerRunning) {
        timerInterval = setInterval(() => {
          timerVal--;
          if (timerVal <= 0) {
            clearInterval(timerInterval);
            timerRunning = false;
            vibrate([100,50,100,50,100]);
            finishExercise();
          } else {
            renderExerciseScreen();
          }
        }, 1000);
      } else {
        clearInterval(timerInterval);
      }
      renderExerciseScreen();
    }

    function resetTimer() {
      clearInterval(timerInterval);
      const dosage = getDosage(currentEx);
      timerVal = dosage.durationMin * 60;
      timerRunning = false;
      renderExerciseScreen();
    }

    function tapRep() {
      vibrate(30);
      const dosage = getDosage(currentEx);
      
      if (dosage.holdTime && !holding) {
        holding = true;
        holdTime = dosage.holdTime;
        renderExerciseScreen();
        holdInterval = setInterval(() => {
          holdTime--;
          if (holdTime <= 0) {
            clearInterval(holdInterval);
            holding = false;
            vibrate(100);
            completeRep();
          } else {
            renderExerciseScreen();
          }
        }, 1000);
      } else if (!dosage.holdTime) {
        completeRep();
      }
    }

    function completeRep() {
      const dosage = getDosage(currentEx);
      const total = dosage.reps || 1;
      repCount++;
      
      if (repCount >= total) {
        if (dosage.perSide && side === 'left') {
          side = 'right';
          repCount = 0;
        } else if (setCount < dosage.sets) {
          setCount++;
          repCount = 0;
          if (dosage.perSide) side = 'left';
        } else {
          vibrate([100,50,100,50,100]);
          finishExercise();
          return;
        }
      }
      holdTime = dosage.holdTime || 0;
      renderExerciseScreen();
    }

    function finishExercise() {
      clearInterval(timerInterval);
      clearInterval(holdInterval);
      exStep = 'feedback';
      timerRunning = false;
      holding = false;
      renderExerciseScreen();
    }

    function selectFeedback(val) {
      feedback = val;
      renderExerciseScreen();
    }

    function completeExercise() {
      if (!feedback) return;
      completed[currentEx] = feedback;
      closeExercise();
      render();
    }

    function vibrate(pattern) {
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    // ============================================
    // INIT
    // ============================================
    render();
  </script>
</body>
</html>
